{"version":3,"file":"index.js","names":["_jsonwebtoken","_interopRequireDefault","require","_models","_helpers","verifyToken","req","res","next","query","debug","isDev","token","headers","decoded","jwt","verify","process","env","API_KEY","usuario","db","User","findByPk","id","status","json","mensaje","success","error","exports","existEmail","body","user_email","findOne","where","user_mail","hasPermissions","attributes","exclude","include","model","Role","rol","role_name"],"sources":["../../src/middlewares/index.js"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport db from '../database/models';\r\nimport { isDev } from '../helpers';\r\n\r\nexport const verifyToken = async (req, res, next) => {\r\n  if (req.query.debug === 'true' && isDev()) return next();\r\n  try {\r\n    const token = req.headers['x-access-token'];\r\n    if (token) {\r\n      const decoded = jwt.verify(token, process.env.API_KEY);\r\n      const usuario = await db.User.findByPk(decoded.id);\r\n      if (usuario) {\r\n        next();\r\n      } else {\r\n        res.status(404).json({\r\n          mensaje: 'No tienes permisos suficientes para realizar la operación',\r\n          success: false\r\n        });\r\n      }\r\n    } else {\r\n      res.status(403).json({ mensaje: 'El token es obligatorio', success: false });\r\n    }\r\n  } catch (error) {\r\n    return res.status(401).json({ mensaje: 'El token no es valido', success: false });\r\n  }\r\n}\r\nexport const existEmail = async (req, res, next) => {\r\n  if (!req.body.user_email) return res.status(400).json({ mensaje: 'El correo es obligatorio', success: false });\r\n  const usuario = await db.User.findOne({ where: { user_mail: req.body.user_email } });\r\n  if (usuario) {\r\n    return res.status(400).json({ mensaje: 'El correo ingresado ya existe', success: false });\r\n  }\r\n  next();\r\n}\r\nexport const hasPermissions = async (req, res, next) => {\r\n  if (req.query.debug === 'true' && isDev()) return next();\r\n  try {\r\n    const token = req.headers['x-access-token'];\r\n    if (token) {\r\n      const decoded = jwt.verify(token, process.env.API_KEY);\r\n      const usuario = await db.User.findByPk(decoded.id, {\r\n        attributes: { exclude: ['user_password'] },\r\n        include: [{ model: db.Role, attributes: ['role_name'] }]\r\n      });\r\n      const rol = usuario.Role.role_name;\r\n      if (usuario && (rol === 'supersu' || rol === 'admin')) {\r\n        next();\r\n      } else {\r\n        res.status(403).json({\r\n          mensaje: 'No tienes permisos suficientes para realizar la operación',\r\n          success: false\r\n        });\r\n      }\r\n    } else {\r\n      res.status(403).json({ mensaje: 'El token es obligatorio', success: false });\r\n    }\r\n  } catch (error) {\r\n    return res.status(401).json({ mensaje: 'El token no es valido', success: false });\r\n  }\r\n}\r\n\r\n"],"mappings":"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"}