{"version":3,"file":"verification.js","names":["_uuidv","require","_bcryptjs","_interopRequireDefault","_models","_mailer","sendVerificationEmail","usuario","verificationOption","admin","passwordGenerated","arguments","length","undefined","recoverySenders","user_id","user_mail","adminMail","uniqueString","uuid","mailOptions","from","process","env","AUTH_EMAIL","to","subject","html","concat","CURRENT_URL","mailDeleteOptions","mailForgotPswOptions","bcc","saltRound","bcrypt","hash","then","hashedUniqueString","db","Token","create","token_uniqueString","token_createdAt","Date","token_expiredAt","addMinutes","result","transporter","sendMail","catch","error","console","log","exports","date","minutes","setMinutes","getMinutes"],"sources":["../../../src/mail/utils/verification.js"],"sourcesContent":["import { uuid } from \"uuidv4\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport db from \"../../database/models\";\r\nimport { transporter } from \"../config/mailer\";\r\n\r\n// Verification email\r\nexport const sendVerificationEmail = async (usuario, verificationOption, admin, passwordGenerated = '', recoverySenders = '') => {\r\n  const { user_id, user_mail } = usuario;\r\n  const adminMail = admin.user_mail\r\n  //  console.log(\"verification\", user_id, user_mail, adminMail);\r\n  //  console.log(passwordGenerated);\r\n  //  console.log(recoverySenders);\r\n\r\n  const uniqueString = uuid() + user_id;\r\n  // console.log(uniqueString, \"href:\", `${process.env.CURRENT_URL+\"user/verify/\"+user_id+\"/\"+uniqueString}`);\r\n\r\n  //mail options for create user\r\n  const mailOptions = {\r\n    from: process.env.AUTH_EMAIL, // sender address\r\n    to: adminMail, // list of receivers\r\n    subject: \"Aprobación de usuario | FuturoCo\", // Subject line \r\n    html: `<div><p>Verifica tu correo eléctrónico para completar el registro de tu cuenta.</p>\r\n               <p>En el siguiente link expira en 6 hrs</p>\r\n               <a href=\"${process.env.CURRENT_URL+\"api/v1/data/email/verifyEmail/\"+user_id+\"/\"+uniqueString}\">VERIFICAR</a>\r\n          </div>`, // html body\r\n  }\r\n\r\n  //mail options for delete User\r\n  const mailDeleteOptions = {\r\n    from: process.env.AUTH_EMAIL, // sender address\r\n    to: adminMail, // list of receivers\r\n    subject: \"Desactivación de usuario | FuturoCo\", // Subject line \r\n    html: `<div><p>Verificación de desactivación de usuario</p>\r\n                <p>En el siguiente link expira en 6 hrs</p>\r\n                <a href=\"${process.env.CURRENT_URL+\"api/v1/data/email/verifyEmailToDelete/\"+user_id+\"/\"+uniqueString}\">VERIFICAR</a>\r\n            </div>`, // html body\r\n  }\r\n\r\n//mail options for delete User\r\n  const mailForgotPswOptions = {\r\n    from: process.env.AUTH_EMAIL, // sender address\r\n    to: admin,\r\n    bcc: recoverySenders, // list of receivers\r\n    subject: \"Correo de Recuperación de Contraseña | FuturoCo\", // Subject line \r\n    html: `<div><p>Su nueva contraseña: <strong>${passwordGenerated}</strong></p>\r\n                <p>Recuerda ir al Link que se encuentra abajo para confirmar el cambio, de lo contrario el procedimiento se debe repetir </p>\r\n                <br>\r\n                <strong>El Link expira en 6 horas.</strong>\r\n                <a href=\"${process.env.CURRENT_URL+\"api/v1/data/email/forgotPswEmail/\"+user_id+\"/\"+passwordGenerated}\">RECUPERAR</a>\r\n            </div>`, // html body\r\n  }\r\n\r\n  // hash the uniqueString\r\n  const saltRound = 10;\r\n  bcrypt\r\n    .hash( uniqueString, saltRound )\r\n    .then( (hashedUniqueString) => {\r\n        // set values in verification token\r\n        db.Token.create({\r\n            token_uniqueString: hashedUniqueString,\r\n            token_createdAt: new Date(),\r\n            token_expiredAt: addMinutes(new Date(), 2),\r\n            user_id\r\n        })\r\n        .then((result)=> {\r\n            // console.log(\"resgistrado\", result)\r\n            transporter.sendMail(verificationOption == 1 ? mailOptions : \r\n                                  verificationOption == 0 ? mailDeleteOptions :\r\n                                   verificationOption == 2 ? mailForgotPswOptions : verificationOption);\r\n        })\r\n        .catch((error) => {\r\n            console.log(error);\r\n        })\r\n        .catch((error) =>{\r\n            console.log(error)\r\n        })\r\n    } )\r\n    .catch((error)=>{\r\n        console.log(error)\r\n    })\r\n}\r\n\r\n  // add  min to Date now\r\n  function addMinutes(date, minutes) {\r\n    date.setMinutes(date.getMinutes() + minutes);\r\n  \r\n    return date;\r\n  }"],"mappings":"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"}